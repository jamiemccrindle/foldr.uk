<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.72">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="Jamie McCrindle Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Jamie McCrindle Blog Atom Feed"><title data-react-helmet="true">Posts tagged &quot;terraform&quot; | Jamie McCrindle</title><meta data-react-helmet="true" property="og:title" content="Posts tagged &quot;terraform&quot; | Jamie McCrindle"><meta data-react-helmet="true" name="description" content="Blog | Tagged &quot;terraform&quot;"><meta data-react-helmet="true" property="og:description" content="Blog | Tagged &quot;terraform&quot;"><meta data-react-helmet="true" property="og:url" content="https://foldr.uk/tags/terraform"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="blog_tags_posts"><link data-react-helmet="true" rel="shortcut icon" href="/img/logo.jpeg"><link data-react-helmet="true" rel="canonical" href="https://foldr.uk/tags/terraform"><link data-react-helmet="true" rel="alternate" href="https://foldr.uk/tags/terraform" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://foldr.uk/tags/terraform" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.9c5a8488.css">
<link rel="preload" href="/assets/js/styles.eec893c3.js" as="script">
<link rel="preload" href="/assets/js/runtime~main.795b3422.js" as="script">
<link rel="preload" href="/assets/js/main.e56afd44.js" as="script">
<link rel="preload" href="/assets/js/common.356acad3.js" as="script">
<link rel="preload" href="/assets/js/2.b79c86b6.js" as="script">
<link rel="preload" href="/assets/js/6875c492.934db1b5.js" as="script">
<link rel="preload" href="/assets/js/7a85f91c.a24bf24d.js" as="script">
<link rel="preload" href="/assets/js/708a5a2f.59172fbd.js" as="script">
<link rel="preload" href="/assets/js/e6f0bbcb.b52765d7.js" as="script">
<link rel="preload" href="/assets/js/7827e86e.5d25b3a0.js" as="script">
<link rel="preload" href="/assets/js/eae10a24.5b4d6649.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"dark")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/logo.jpeg" alt="Jamie McCrindle Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo.jpeg" alt="Jamie McCrindle Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">Jamie McCrindle</strong></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/jamiemccrindle" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><a href="https://twitter.com/foldr" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Twitter</a><div class="react-toggle react-toggle--checked react-toggle--disabled displayOnlyInLargeViewport_GrZ2"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" checked="" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/logo.jpeg" alt="Jamie McCrindle Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo.jpeg" alt="Jamie McCrindle Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">Jamie McCrindle</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/">Blog</a></li><li class="menu__list-item"><a href="https://github.com/jamiemccrindle" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li><li class="menu__list-item"><a href="https://twitter.com/foldr" target="_blank" rel="noopener noreferrer" class="menu__link">Twitter</a></li></ul></div></div></div></nav><div class="main-wrapper blog-wrapper"><div class="container margin-vert--lg"><div class="row"><div class="col col--3"><div class="sidebar_2ahu thin-scrollbar"><h3 class="sidebarItemTitle_2hhb">Recent posts</h3><ul class="sidebarItemList_2xAf"><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/microsoft-graph-terraform-data-source">Microsoft Graph API Terraform Data Source</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/bootstrap-terraform-state-in-azure">Bootstrap terraform state in azure</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/terraform-rotate-secrets">Safely rotate secrets with terraform</a></li></ul></div></div><main class="col col--7"><h1>3 posts tagged with &quot;terraform&quot;</h1><a href="/tags">View All Tags</a><div class="margin-vert--xl"><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_GeHD"><a href="/microsoft-graph-terraform-data-source">Microsoft Graph API Terraform Data Source</a></h2><div class="margin-vert--md"><time datetime="2021-04-19T00:00:00.000Z" class="blogPostDate_fNvV">April 19, 2021 Â· 2 min read</time></div><div class="avatar margin-vert--md"><a href="https://github.com/jamiemccrindle" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img src="https://avatars.githubusercontent.com/u/909696?s=60&amp;v=4" alt="Jamie McCrindle"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/jamiemccrindle" target="_blank" rel="noopener noreferrer">Jamie McCrindle</a></h4><small class="avatar__subtitle">foldr</small></div></div></header><div class="markdown"><p>Most Terraform examples that reference permissions from the Microsoft Graph use the GUIDs for the permissions. This makes
it harder to write the Terraform config, as you have to look up the GUIDs for each permission. It also makes it harder
to do code reviews where reviewers typically just believe the comment that describes what permission the GUID represents.</p><p>This is what the code for the required_resource_access for an azure ad application for k8s looks like using just the GUIDs
(this is from a real example online):</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly terraform"><div tabindex="0" class="prism-code language-terraform codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">required_resource_access {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  resource_app_id = &quot;00000003-0000-0000-c000-000000000000&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  resource_access {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    id   = &quot;7ab1d382-f21e-4acd-a863-ba3e13f7da61&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    type = &quot;Role&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  resource_access {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    id   = &quot;06da0dbc-49e2-44d2-8312-53f166ab848a&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    type = &quot;Scope&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  resource_access {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    id   = &quot;e1fe6dd8-ba31-4d61-89e7-88639da4683d&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    type = &quot;Scope&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Your AD tenant should have enterprise applications (service principals) for the various Microsoft services including
the Microsoft Graph.</p><p><img alt="Microsoft Graph Enterprise Application" src="/assets/images/enterprise-applications-05e63a1d48cebcbf37a8241215dcf691.png"></p><p>You can look this up as a data source using Terraform as follows:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly terraform"><div tabindex="0" class="prism-code language-terraform codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">data &quot;azuread_service_principal&quot; &quot;graph&quot; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    # graph api application id</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    application_id = &quot;00000003-0000-0000-c000-000000000000&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>This will return a data source that has all of the oauth2 permissions and app roles for the Microsoft Graph. They can be awkward to
work with, so I&#x27;ll usually create a new object that maps the permission name to the permission id e.g.:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly terraform"><div tabindex="0" class="prism-code language-terraform codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">locals {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    graph = {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        application_id = data.azuread_service_principal.graph.application_id</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        app_roles = {for app_role in data.azuread_service_principal.graph.app_roles : app_role.value =&gt; app_role.id}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        oauth2_permissions = {for oauth2_permission in data.azuread_service_principal.graph.oauth2_permissions : oauth2_permission.value =&gt; oauth2_permission.id}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Using this, the example above would look like:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly terraform"><div tabindex="0" class="prism-code language-terraform codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">required_resource_access {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  resource_app_id = local.graph.application_id</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  resource_access {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    id   = local.graph.app_roles[&quot;Directory.Read.All&quot;]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    type = &quot;Role&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  resource_access {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    id   = local.graph.oauth2_permissions[&quot;Directory.Read.All&quot;]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    type = &quot;Scope&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  resource_access {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    id   = local.graph.oauth2_permissions[&quot;User.Read&quot;]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    type = &quot;Scope&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div></div><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/tags/terraform">terraform</a><a class="margin-horiz--sm" href="/tags/azure">azure</a></div><div class="col text--right"><a aria-label="Read more about Microsoft Graph API Terraform Data Source" href="/microsoft-graph-terraform-data-source"><strong>Read More</strong></a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_GeHD"><a href="/bootstrap-terraform-state-in-azure">Bootstrap terraform state in azure</a></h2><div class="margin-vert--md"><time datetime="2021-04-18T00:00:00.000Z" class="blogPostDate_fNvV">April 18, 2021 Â· 2 min read</time></div><div class="avatar margin-vert--md"><a href="https://github.com/jamiemccrindle" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img src="https://avatars.githubusercontent.com/u/909696?s=60&amp;v=4" alt="Jamie McCrindle"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/jamiemccrindle" target="_blank" rel="noopener noreferrer">Jamie McCrindle</a></h4><small class="avatar__subtitle">foldr</small></div></div></header><div class="markdown"><p>It&#x27;s a good idea to store your Terraform state in a remote backend because:</p><ul><li>Terraform state often contains sensitive information e.g. credentials, access tokens etc. so using a backend that has access control and encrypts the state at rest and in transit will keep it safter.</li><li>Your Terraform state can be backed up</li><li>You can retrieve your state when running scripts in CI / CD pipelines.</li></ul><p>If you&#x27;re using Terraform to configure Azure resources, you&#x27;ll probably want to use the <a href="https://www.terraform.io/docs/language/settings/backends/azurerm.html" target="_blank" rel="noopener noreferrer">azurerm terraform backend</a>.</p><p>This stores your state in an Azure Storage Account. The following Terraform will create a storage account that can be used to store your Terraform state in Azure:</p><p><code>main.tf</code></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly terraform"><div tabindex="0" class="prism-code language-terraform codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">resource &quot;azurerm_resource_group&quot; &quot;terraform_state&quot; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  name     = var.resource_group_name</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  location = var.location</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">resource &quot;azurerm_storage_account&quot; &quot;terraform_state&quot; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  name                     = var.storage_account_name</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  resource_group_name      = azurerm_resource_group.terraform_state.name</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  location                 = azurerm_resource_group.terraform_state.location</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  account_tier             = &quot;Standard&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  account_replication_type = &quot;GRS&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  min_tls_version          = &quot;TLS1_2&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">resource &quot;azurerm_storage_container&quot; &quot;terraform_state&quot; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  name                  = var.container_name</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  storage_account_name  = azurerm_storage_account.terraform_state.name</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  container_access_type = &quot;private&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">variable &quot;resource_group_name&quot; { type = string }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">variable &quot;storage_account_name&quot; { type = string }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">variable &quot;container_name&quot; { type = string }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">variable &quot;location&quot; { type = string }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>To run it, you&#x27;ll need to supply a file with the following variables set:</p><p><code>bootstrap.tfvars</code></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain"># the name of the resource group</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># e.g. &quot;rg-mytfstate-shared-001&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">resource_group_name = &quot;&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># the name of the storage account</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># e.g. &quot;sttfstate001&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">storage_account_name = &quot;&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># the name of the container</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># e.g. &quot;tfstate&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">container_name = &quot;tfstate&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># the location of the resouce group </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># and storage account e.g. &quot;West Europe&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">location = &quot;West Europe&quot;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>To apply the terraform run the following</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><div tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># log into azure, this assumes you have sufficient </span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># privileges to create resource groups</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">az login</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># initialise terraform</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">terraform init</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># show a plan</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">terraform plan -var-file</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">bootstrap.tfvars</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># apply the terraform</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">terraform apply -var-file</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">bootstrap.tfvars</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div></div><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/tags/terraform">terraform</a><a class="margin-horiz--sm" href="/tags/azure">azure</a></div><div class="col text--right"><a aria-label="Read more about Bootstrap terraform state in azure" href="/bootstrap-terraform-state-in-azure"><strong>Read More</strong></a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_GeHD"><a href="/terraform-rotate-secrets">Safely rotate secrets with terraform</a></h2><div class="margin-vert--md"><time datetime="2021-04-10T00:00:00.000Z" class="blogPostDate_fNvV">April 10, 2021 Â· 2 min read</time></div><div class="avatar margin-vert--md"><a href="https://github.com/jamiemccrindle" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img src="https://avatars.githubusercontent.com/u/909696?s=60&amp;v=4" alt="Jamie McCrindle"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/jamiemccrindle" target="_blank" rel="noopener noreferrer">Jamie McCrindle</a></h4><small class="avatar__subtitle">foldr</small></div></div></header><div class="markdown"><p>Rotating secrets is a Good Thingâ„¢ as it limits the length of a time a compromised set of credentials can be used for.</p><p>It&#x27;s quite difficult to make secret rotation atomic i.e. changing a secret in your identity provider at exactly the same
time you change the secret in the system that uses it for authentication. Mismatches between the values will result in
authentication failures.</p><p>The ideal is where the identity provider supports multiple valid secrets for a single identity e.g. Azure Service Principals. If that&#x27;s
the case, you can have 2 secrets active at the same time and rotate them on offset time periods e.g.:</p><p><img alt="password rotation" src="/assets/images/rotation.drawio-74132fb1c49e6242631f86f6761209c4.svg" title="Secret Rotation"></p><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><p>This example uses secrets that expire after 60 days and rotates them each month. The mechanism supports rotating secrets more frequently
so pick an expiry window that meets your risk appetite. The limiting factor is often when infrastructure needs to be redeployed after
a secret is rotated.</p></div></div><p>In the terraform below, I&#x27;ve set up 2 passwords, one called <code>even</code> and one called <code>odd</code>.</p><p>The <code>odd</code> password rotates at the beginning of the odd months and is the current password for those months i.e.:</p><ul><li>January, March, May, July, September, November</li></ul><p>And the <code>even</code> password rotates at the beginning of the even months and is the current password for those months i.e.:</p><ul><li>February, April, June, August, October, December</li></ul><p>And now for the terraform:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly terraform"><div tabindex="0" class="prism-code language-terraform codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">variable &quot;date&quot; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    type = string</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">locals {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  date        = tonumber(var.date)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  odd_keeper  = floor((local.date + 1) / 2)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  even_keeper = floor(local.date / 2)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  use_even    = local.date % 2 == 0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">resource &quot;random_password&quot; &quot;odd&quot; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  keepers = {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;date&quot; = local.odd_keeper</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  length           = 64</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  special          = true</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">resource &quot;random_password&quot; &quot;even&quot; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  keepers = {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;date&quot; = local.even_keeper</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  length           = 64</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  special          = true</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># this example just outputs the password</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># but you&#x27;d typically use this as a property of</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># the system(s) that need the password.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">output &quot;current_secret&quot; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    value = local.use_even </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                ? random_password.even.result </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                : random_password.odd.result</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>For this to work, you need to supply a <code>date</code> variable when you call terraform that contains the current year and month e.g.:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><div tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">terraform apply -auto-approve -var</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;date=</span><span class="token string variable" style="color:rgb(191, 199, 213)">`</span><span class="token string variable function" style="color:rgb(130, 170, 255)">date</span><span class="token string variable" style="color:rgb(191, 199, 213)"> +%Y%m</span><span class="token string variable" style="color:rgb(191, 199, 213)">`</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><div class="admonition admonition-caution alert alert--warning"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>caution</h5></div><div class="admonition-content"><p>Terraform will store these secrets in terraform state, so make sure you&#x27;re <a href="https://www.terraform.io/docs/language/state/sensitive-data.html" target="_blank" rel="noopener noreferrer">using a backend that is appropriately secured</a>.</p></div></div></div><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/tags/terraform">terraform</a><a class="margin-horiz--sm" href="/tags/secrets">secrets</a><a class="margin-horiz--sm" href="/tags/security">security</a></div><div class="col text--right"><a aria-label="Read more about Safely rotate secrets with terraform" href="/terraform-rotate-secrets"><strong>Read More</strong></a></div></footer></article></div></main></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Socials</h4><ul class="footer__items"><li class="footer__item"><a href="https://twitter.com/foldr" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li><li class="footer__item"><a href="https://github.com/jamiemccrindle" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li><li class="footer__item"><a href="https://jamie.mccrindle.org" target="_blank" rel="noopener noreferrer" class="footer__link-item">jamie.mccrindle.org</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 Jamie McCrindle. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/styles.eec893c3.js"></script>
<script src="/assets/js/runtime~main.795b3422.js"></script>
<script src="/assets/js/main.e56afd44.js"></script>
<script src="/assets/js/common.356acad3.js"></script>
<script src="/assets/js/2.b79c86b6.js"></script>
<script src="/assets/js/6875c492.934db1b5.js"></script>
<script src="/assets/js/7a85f91c.a24bf24d.js"></script>
<script src="/assets/js/708a5a2f.59172fbd.js"></script>
<script src="/assets/js/e6f0bbcb.b52765d7.js"></script>
<script src="/assets/js/7827e86e.5d25b3a0.js"></script>
<script src="/assets/js/eae10a24.5b4d6649.js"></script>
</body>
</html>