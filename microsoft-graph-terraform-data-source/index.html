<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.72">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="Jamie McCrindle Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Jamie McCrindle Blog Atom Feed"><title data-react-helmet="true">Microsoft Graph API Terraform Data Source | Jamie McCrindle</title><meta data-react-helmet="true" property="og:title" content="Microsoft Graph API Terraform Data Source | Jamie McCrindle"><meta data-react-helmet="true" name="description" content="Most Terraform examples that reference permissions from the Microsoft Graph use the GUIDs for the permissions. This makes"><meta data-react-helmet="true" property="og:description" content="Most Terraform examples that reference permissions from the Microsoft Graph use the GUIDs for the permissions. This makes"><meta data-react-helmet="true" property="og:url" content="https://foldr.uk/microsoft-graph-terraform-data-source"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><link data-react-helmet="true" rel="shortcut icon" href="/img/logo.jpeg"><link data-react-helmet="true" rel="canonical" href="https://foldr.uk/microsoft-graph-terraform-data-source"><link data-react-helmet="true" rel="alternate" href="https://foldr.uk/microsoft-graph-terraform-data-source" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://foldr.uk/microsoft-graph-terraform-data-source" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.9c5a8488.css">
<link rel="preload" href="/assets/js/styles.d280c8f1.js" as="script">
<link rel="preload" href="/assets/js/runtime~main.388a180b.js" as="script">
<link rel="preload" href="/assets/js/main.5c71dd6a.js" as="script">
<link rel="preload" href="/assets/js/1.6aa5db14.js" as="script">
<link rel="preload" href="/assets/js/2.32468f44.js" as="script">
<link rel="preload" href="/assets/js/ccc49370.c0dc0fda.js" as="script">
<link rel="preload" href="/assets/js/7a85f91c.cf4c735b.js" as="script">
<link rel="preload" href="/assets/js/8eb4bfd8.1ecd2bce.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"dark")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/logo.jpeg" alt="Jamie McCrindle Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo.jpeg" alt="Jamie McCrindle Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">Jamie McCrindle</strong></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/jamiemccrindle" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><a href="https://twitter.com/foldr" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Twitter</a><div class="react-toggle react-toggle--checked react-toggle--disabled displayOnlyInLargeViewport_GrZ2"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" checked="" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/logo.jpeg" alt="Jamie McCrindle Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo.jpeg" alt="Jamie McCrindle Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">Jamie McCrindle</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/">Blog</a></li><li class="menu__list-item"><a href="https://github.com/jamiemccrindle" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li><li class="menu__list-item"><a href="https://twitter.com/foldr" target="_blank" rel="noopener noreferrer" class="menu__link">Twitter</a></li></ul></div></div></div></nav><div class="main-wrapper blog-wrapper"><div class="container margin-vert--lg"><div class="row"><div class="col col--3"><div class="sidebar_2ahu thin-scrollbar"><h3 class="sidebarItemTitle_2hhb">Recent posts</h3><ul class="sidebarItemList_2xAf"><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/rotating-azure-credentials-in-github-with-terraform">How to rotate your AZURE_CREDENTIALS in GitHub with Terraform</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/how-to-install-a-specific-version-of-terraform-github-actions-using-apt-get">Install a specific version of Terraform in a Github Action using apt</a></li><li class="sidebarItem_2UVv"><a aria-current="page" class="sidebarItemLink_1RT6 sidebarItemLinkActive_12pM" href="/microsoft-graph-terraform-data-source">Microsoft Graph API Terraform Data Source</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/bootstrap-terraform-state-in-azure">Bootstrap terraform state in azure</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/terraform-rotate-secrets">Safely rotate secrets with terraform</a></li></ul></div></div><main class="col col--7"><article><header><h1 class="margin-bottom--sm blogPostTitle_GeHD">Microsoft Graph API Terraform Data Source</h1><div class="margin-vert--md"><time datetime="2021-04-19T00:00:00.000Z" class="blogPostDate_fNvV">April 19, 2021 Â· 2 min read</time></div><div class="avatar margin-vert--md"><a href="https://github.com/jamiemccrindle" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img src="https://avatars.githubusercontent.com/u/909696?s=60&amp;v=4" alt="Jamie McCrindle"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/jamiemccrindle" target="_blank" rel="noopener noreferrer">Jamie McCrindle</a></h4><small class="avatar__subtitle">foldr</small></div></div></header><div class="markdown"><p>Most Terraform examples that reference permissions from the Microsoft Graph use the GUIDs for the permissions. This makes
it harder to write the Terraform config, as you have to look up the GUIDs for each permission. It also makes it harder
to do code reviews where reviewers typically just believe the comment that describes what permission the GUID represents.</p><p>This is what the code for the required_resource_access for an azure ad application for k8s looks like using just the GUIDs
(this is from a real example online):</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly hcl"><div tabindex="0" class="prism-code language-hcl codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">required_resource_access {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  resource_app_id = &quot;00000003-0000-0000-c000-000000000000&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  resource_access {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    id   = &quot;7ab1d382-f21e-4acd-a863-ba3e13f7da61&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    type = &quot;Role&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  resource_access {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    id   = &quot;06da0dbc-49e2-44d2-8312-53f166ab848a&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    type = &quot;Scope&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  resource_access {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    id   = &quot;e1fe6dd8-ba31-4d61-89e7-88639da4683d&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    type = &quot;Scope&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Your AD tenant should have enterprise applications (service principals) for the various Microsoft services including
the Microsoft Graph.</p><p><img alt="Microsoft Graph Enterprise Application" src="/assets/images/enterprise-applications-05e63a1d48cebcbf37a8241215dcf691.png"></p><p>You can look this up as a data source using Terraform as follows:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly hcl"><div tabindex="0" class="prism-code language-hcl codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">data &quot;azuread_service_principal&quot; &quot;graph&quot; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    # graph api application id</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    application_id = &quot;00000003-0000-0000-c000-000000000000&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>This will return a data source that has all of the oauth2 permissions and app roles for the Microsoft Graph. They can be awkward to
work with, so I&#x27;ll usually create a new object that maps the permission name to the permission id e.g.:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly hcl"><div tabindex="0" class="prism-code language-hcl codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">locals {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    graph = {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        application_id = data.azuread_service_principal.graph.application_id</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        app_roles = {for app_role in data.azuread_service_principal.graph.app_roles : app_role.value =&gt; app_role.id}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        oauth2_permissions = {for oauth2_permission in data.azuread_service_principal.graph.oauth2_permissions : oauth2_permission.value =&gt; oauth2_permission.id}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Using this, the example above would look like:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly hcl"><div tabindex="0" class="prism-code language-hcl codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">required_resource_access {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  resource_app_id = local.graph.application_id</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  resource_access {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    id   = local.graph.app_roles[&quot;Directory.Read.All&quot;]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    type = &quot;Role&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  resource_access {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    id   = local.graph.oauth2_permissions[&quot;Directory.Read.All&quot;]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    type = &quot;Scope&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  resource_access {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    id   = local.graph.oauth2_permissions[&quot;User.Read&quot;]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    type = &quot;Scope&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><div class="admonition admonition-tip alert alert--success"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</h5></div><div class="admonition-content"><p>Note: this works for more than just the Microsoft Graph, you can use the same technique to look up app roles and permissions from any of your
enterprise applications.</p></div></div></div><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/tags/terraform">terraform</a><a class="margin-horiz--sm" href="/tags/azure">azure</a></div></footer></article><div><a href="https://github.com/jamiemccrindle/foldr.uk/tree/main/foldr-uk-website/blog/blog/2021-04-19-microsoft-graph-terraform-data-source.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-label="Edit page"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="margin-vert--xl"><nav class="pagination-nav" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/how-to-install-a-specific-version-of-terraform-github-actions-using-apt-get"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Â« Install a specific version of Terraform in a Github Action using apt</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/bootstrap-terraform-state-in-azure"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Bootstrap terraform state in azure Â»</div></a></div></nav></div></main><div class="col col--2"><div class="tableOfContents_35-E thin-scrollbar"></div></div></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Socials</h4><ul class="footer__items"><li class="footer__item"><a href="https://twitter.com/foldr" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li><li class="footer__item"><a href="https://github.com/jamiemccrindle" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li><li class="footer__item"><a href="https://jamie.mccrindle.org" target="_blank" rel="noopener noreferrer" class="footer__link-item">jamie.mccrindle.org</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 Jamie McCrindle. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/styles.d280c8f1.js"></script>
<script src="/assets/js/runtime~main.388a180b.js"></script>
<script src="/assets/js/main.5c71dd6a.js"></script>
<script src="/assets/js/1.6aa5db14.js"></script>
<script src="/assets/js/2.32468f44.js"></script>
<script src="/assets/js/ccc49370.c0dc0fda.js"></script>
<script src="/assets/js/7a85f91c.cf4c735b.js"></script>
<script src="/assets/js/8eb4bfd8.1ecd2bce.js"></script>
</body>
</html>